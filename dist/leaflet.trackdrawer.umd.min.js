!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("leaflet"),require("@mapbox/corslite")):"function"==typeof define&&define.amd?define(["leaflet","@mapbox/corslite"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).leaflet_trackdrawer=t(e.L,e.corslite)}(this,(function(e,t){"use strict";function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var o=n(e),r=n(t);function i(e,t,n,o,r,i,a){try{var s=e[i](a),d=s.value}catch(e){return void n(e)}s.done?t(d):Promise.resolve(d).then(o,r)}function a(e){return function(){var t=this,n=arguments;return new Promise((function(o,r){var a=e.apply(t,n);function s(e){i(a,o,r,s,d,"next",e)}function d(e){i(a,o,r,s,d,"throw",e)}s(void 0)}))}}var s={red:"#D63E2A",orange:"#F59630",green:"#72B026",blue:"#38AADD",purple:"#D252B9",darkred:"#A23336",darkblue:"#0067A3",darkgreen:"#728224",darkpurple:"#5B396B",cadetblue:"#436978",lightred:"#FF8E7F",beige:"#FFCB92",lightgreen:"#BBF970",lightblue:"#8ADAFF",pink:"#FF91EA",white:"#FBFBFB",lightgray:"#A3A3A3",gray:"#575757",black:"#303030"},d=["blue","green","orange","purple","red","darkblue","darkpurple","lightblue","lightgreen","beige","pink","lightred"];Object.freeze(s),Object.freeze(d);var u={nameOf:function(e){return d[e%d.length]},rgbOf:function(e){return s[this.nameOf(e)]},nameToRgb:function(e){return s[e]},rgbToName:function(e){return Object.keys(s).find((function(t){return s[t]===e}))}},l=o.default.Evented.extend({initialize:function(e){this._parent=e;var t=o.default.featureGroup().addTo(e).addEventParent(this);this._elements=[t],this.length=1},get:function(e){var t=e<0?this._elements.length+e:e;return this._elements[t]},splice:function(){var e,t=this,n=(e=this._elements).splice.apply(e,arguments);if(n.forEach((function(e){return e.removeFrom(t._parent).removeEventParent(t)})),arguments.length>2){var o=Array.prototype.slice.call(arguments,2);o.forEach((function(e){e.addTo(t._parent).addEventParent(t)}))}return this.length=this._elements.length,n},forEach:function(e){this._elements.forEach(e)},clean:function(){this._elements[0].clearLayers(),this.splice(1)},getLayer:function(e){var t=this._elements.find((function(t){return void 0!==t.getLayer(e)}));return void 0!==t?t.getLayer(e):void 0},getLayerId:function(e){var t=this._elements.find((function(t){return t.hasLayer(e)}));return void 0!==t?t.getLayerId(e):void 0},getLayerIndex:function(e){return this._elements.findIndex((function(t){return t.hasLayer(e)}))}}),c=o.default.Polyline.extend({_startMarkerId:void 0,_endMarkerId:void 0,_promoted:!1,_demoted:!0,_computation:0,options:{metadata:{}},initialize:function(e,t){o.default.Polyline.prototype.initialize.call(this,e,t),o.default.setOptions(this,t),this.options.metadata=JSON.parse(JSON.stringify(this.options.metadata))}}),f={Edge:c,edge:function(e,t){return new c(e,t)}},h=f.Edge;function g(e){for(var t=[],n=e.length,o=0;o<n;o+=1)t.push(e[o].lat),t.push(e[o].lng);return t}function p(e){for(var t=[],n=e.length,r=0;r<n;r+=2)t.push(o.default.latLng(e[r],e[r+1]));return t}function _(e){return[e.lat,e.lng]}function v(e){return o.default.latLng(e[0],e[1])}var m=o.default.LayerGroup.extend({options:{routingCallback:void 0,router:void 0,debug:!1,undoable:!0,undoDepth:30},_getPrevious:function(e){var t=void 0!==e?this._getEdge(e._routeIdPrevious):void 0;return{previousEdge:t,previousNode:void 0!==t?this._getNode(t._startMarkerId):void 0}},_getNext:function(e){var t=void 0!==e?this._getEdge(e._routeIdNext):void 0;return{nextEdge:t,nextNode:void 0!==t?this._getNode(t._endMarkerId):void 0}},_getNodeId:function(e){return this._nodesContainers.getLayerId(e)},_getEdgeId:function(e){return this._edgesContainers.getLayerId(e)},_getNode:function(e){return this._nodesContainers.getLayer(e)},_getEdge:function(e){return this._edgesContainers.getLayer(e)},_getNodeContainerIndex:function(e){return this._nodesContainers.getLayerIndex(e)},_getNodeContainer:function(e){return this._nodesContainers.get(this._getNodeContainerIndex(e))},_getEdgeContainerIndex:function(e){return this._edgesContainers.getLayerIndex(e)},_getEdgeContainer:function(e){return this._edgesContainers.get(this._getEdgeContainerIndex(e))},initialize:function(e){this.setOptions(e),o.default.LayerGroup.prototype.initialize.call(this),this._nodesContainers=new l(this),this._edgesContainers=new l(this),this._firstNodeId=void 0,this._lastNodeId=void 0,this._currentColorIndex=0,this._fireEvents=!0,this._computing=0,this._states=null,this._currentStateIndex=null,this.options.undoable&&(this._states=[],this._states.push(this.getState()),this._currentStateIndex=0)},setOptions:function(e){var t=this;o.default.setOptions(this,e),void 0!==this.options.router&&(this.options.routingCallback=function(e,n,r){t.options.router.route([o.default.Routing.waypoint(e.getLatLng()),o.default.Routing.waypoint(n.getLatLng())],(function(e,t){r(e,t?t[0].coordinates:null,{})}))})},hasNodes:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=0;return this._nodesContainers.forEach((function(e){var n=e.getLayers();t+=n.length})),t>=e},getNodes:function(){var e=[];return this._nodesContainers.forEach((function(t){var n=t.getLayers();n.length>0&&e.push({container:t,markers:n})})),e},getNodesContainer:function(){return this._nodesContainers},getSteps:function(){var e=[];return this._edgesContainers.forEach((function(t){var n=t.getLayers();n.length>0&&e.push({container:t,edges:n})})),e},getStepsContainer:function(){return this._edgesContainers},getBounds:function(){var e=o.default.latLngBounds([]);return this._nodesContainers.forEach((function(t){e.extend(t.getBounds())})),this._edgesContainers.forEach((function(t){e.extend(t.getBounds())})),e},getLatLngs:function(){var e=this,t=void 0!==o.default.TrackStats,n=[],r=this._getNode(this._firstNodeId);return this._nodesContainers.forEach((function(){var i=[];do{var a=e._getNext(r),s=a.nextEdge,d=a.nextNode;if(void 0===r||void 0===s)break;s.getLatLngs().forEach((function(e){i.push(t?o.default.TrackStats.cache.getAll(e):e)})),r=d}while("stopover"!==r.options.type);n.push(JSON.parse(JSON.stringify(i)))})),n},_stopoversToGeoJSON:function(){var e=this,t=[],n=[],r=this._getNode(this._firstNodeId);void 0!==r&&t.push(r),this._nodesContainers.forEach((function(){do{var n=e._getNext(r),o=n.nextEdge,i=n.nextNode;if(void 0===r||void 0===o)break;r=i}while("stopover"!==r.options.type);void 0!==r&&t.push(r)}));var i=void 0!==o.default.TrackStats;return t.forEach((function(e,t){var r=i?o.default.TrackStats.cache.getAll(e.getLatLng()):e.getLatLng(),a=JSON.parse(JSON.stringify(e.options.metadata));a.index=t,n.push({type:"Feature",properties:a,geometry:{type:"Point",coordinates:"z"in r&&null!==r.z?[r.lng,r.lat,r.z]:[r.lng,r.lat]}})})),n},_edgesToFlatGeoJSON:function(){var e=this,t=void 0!==o.default.TrackStats,n={type:"Feature",properties:{index:0},geometry:{type:"LineString",coordinates:[]}},r=this._getNode(this._firstNodeId);return this._nodesContainers.forEach((function(){do{var i=e._getNext(r),a=i.nextEdge,s=i.nextNode;if(void 0===r||void 0===a)break;a.getLatLngs().forEach((function(e){var r=t?o.default.TrackStats.cache.getAll(e):e;n.geometry.coordinates.push("z"in r&&null!==r.z?[r.lng,r.lat,r.z]:[r.lng,r.lat])})),r=s}while("stopover"!==r.options.type)})),n},_edgesToGeoJSON:function(){var e=this,t=void 0!==o.default.TrackStats,n=[],r=this._getNode(this._firstNodeId);return this._nodesContainers.forEach((function(i,a){var s=function(){var i=e._getNext(r),s=i.nextEdge,d=i.nextNode;if(void 0===r||void 0===s)return"break";var u=JSON.parse(JSON.stringify(s.options.metadata));u.index=a;var l={type:"Feature",properties:u,geometry:{type:"LineString",coordinates:[]}};s.getLatLngs().forEach((function(e){var n=t?o.default.TrackStats.cache.getAll(e):e;l.geometry.coordinates.push("z"in n&&null!==n.z?[n.lng,n.lat,n.z]:[n.lng,n.lat])})),n.push(l),r=d};do{if("break"===s())break}while("stopover"!==r.options.type)})),n},toGeoJSON:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n={type:"FeatureCollection",features:[]};return e&&this._stopoversToGeoJSON().forEach((function(e){return n.features.push(e)})),t?n.features.push(this._edgesToFlatGeoJSON()):this._edgesToGeoJSON().forEach((function(e){return n.features.push(e)})),n},getState:function(){var e=this,t=[{version:2,start:void 0,metadata:void 0}],n=this._getNode(this._firstNodeId);return void 0!==n&&(t[0].start=_(n.getLatLng()),t[0].metadata=JSON.parse(JSON.stringify(n.options.metadata))),this._nodesContainers.forEach((function(){var o=[];do{var r=e._getNext(n),i=r.nextEdge,a=r.nextNode;if(void 0===n||void 0===i)break;o.push({end:_(a.getLatLng()),edge:g(i.getLatLngs()),metadata:{node:JSON.parse(JSON.stringify(a.options.metadata)),edge:JSON.parse(JSON.stringify(i.options.metadata))}}),n=a}while("stopover"!==n.options.type);o.length>0&&t.push(o)})),t},_fireStart:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._fireEvents&&0===this._computing&&this.fire("TrackDrawer:start",e),this._computing+=1},_fireDone:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._computing-=1,this._fireEvents&&0===this._computing&&this._pushState(),this._fireEvents&&0===this._computing&&this.fire("TrackDrawer:done",e)},_fireFailed:function(e){this._computing-=1,this._fireEvents&&0===this._computing&&this.fire("TrackDrawer:failed",{message:e.message})},refreshEdges:function(e){var t=this;return a(regeneratorRuntime.mark((function n(){var o,r,i;return regeneratorRuntime.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return o=e||t.options.routingCallback,t._fireStart(),r=t._fireEvents,t._fireEvents=!1,i=[],t._nodesContainers.forEach((function(e){e.getLayers().forEach((function(e){i.push(t.onMoveNode(e,o))}))})),n.next=8,Promise.all(i);case 8:return t._fireEvents=r,t._fireDone(),n.abrupt("return",t);case 11:case"end":return n.stop()}}),n)})))()},clean:function(){return this._fireStart(),this._edgesContainers.clean(),this._nodesContainers.clean(),this._firstNodeId=void 0,this._lastNodeId=void 0,this._currentColorIndex=0,this._fireDone(),this},_createNode:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return o.default.TrackDrawer.node(e,{metadata:t})},restoreState:function(e,t){var n=this;return a(regeneratorRuntime.mark((function o(){var r,i,a,s,d,u;return regeneratorRuntime.wrap((function(o){for(;;)switch(o.prev=o.next){case 0:return r=t||n._createNode,n._fireStart(),i=n._fireEvents,n._fireEvents=!1,n.clean(),a=[],s=[],d=[],e.forEach((function(t,o){if(0!==o)t.forEach((function(i,l){var c=r.call(null,v(i.end),u>=2?i.metadata.node:{});l===t.length-1&&o<e.length-1&&a.push(c),d.push(n.addNode(c,(function(e,t,n){var o=p(i.edge);s.push({from:e,to:t,edge:o}),n(null,o,u>=2?i.metadata.edge:{})}),!0))}));else if(u=t.version,t.start){var i=r.call(null,v(t.start),u>=2?t.metadata:{});d.push(n.addNode(i,(function(){throw new Error("Should not be called")}),!0))}})),o.next=11,Promise.all(d);case 11:return a.forEach((function(e){return n.promoteNodeToStopover(e)})),n._fireEvents=i,n._fireDone({routes:s}),o.abrupt("return",n);case 15:case"end":return o.stop()}}),o)})))()},_pushState:function(){this.options.undoable&&!this._undoing&&(this._currentStateIndex+1!==this._states.length&&this._states.splice(this._currentStateIndex+1),this._currentStateIndex+=1,this._states.push(this.getState()),this._states.length-1>this.options.undoDepth&&(this._states.splice(0,1),this._currentStateIndex-=1))},undo:function(e){var t=this;return a(regeneratorRuntime.mark((function n(){return regeneratorRuntime.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!t.isUndoable()||0!==t._computing){n.next=7;break}return t._currentStateIndex-=1,t._undoing=!0,n.next=5,t.restoreState(t._states[t._currentStateIndex],e);case 5:return t._undoing=!1,n.abrupt("return",!0);case 7:return n.abrupt("return",!1);case 8:case"end":return n.stop()}}),n)})))()},isUndoable:function(){return this.options.undoable&&this._currentStateIndex>0},isRedoable:function(){return this.options.undoable&&this._currentStateIndex<this._states.length-1},redo:function(e){var t=this;return a(regeneratorRuntime.mark((function n(){return regeneratorRuntime.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!t.isRedoable()||0!==t._computing){n.next=7;break}return t._currentStateIndex+=1,t._undoing=!0,n.next=5,t.restoreState(t._states[t._currentStateIndex],e);case 5:return t._undoing=!1,n.abrupt("return",!0);case 7:return n.abrupt("return",!1);case 8:case"end":return n.stop()}}),n)})))()},addLayer:function(e){e instanceof o.default.Marker?this.addNode(e):o.default.LayerGroup.prototype.addLayer.call(this,e)},_createEdge:function(e,t){var n=this,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=this._edgesContainers.get(this._getNodeContainerIndex(e)),i=new h([e.getLatLng(),t.getLatLng()],{color:u.nameToRgb(e.options.colorName),dashArray:"4",metadata:o}).addTo(r),a=r.getLayerId(i);return e._routeIdNext=a,t._routeIdPrevious=a,i._startMarkerId=this._getNodeId(e),i._endMarkerId=this._getNodeId(t),i._computation=0,this.options.debug&&(i.on("tooltipopen",(function(){var e=i._startMarkerId,t=i._endMarkerId;i.setTooltipContent("id: ".concat(n._getEdgeId(i)," (on #").concat(n._getEdgeContainerIndex(i),")<br>")+"previous node: ".concat(e)+" (on #".concat(n._getNodeContainerIndex(n._getNode(e)),")<br>")+"next node: ".concat(t)+" (on #".concat(n._getNodeContainerIndex(n._getNode(t)),")"))})),i.bindTooltip("<>")),i},_prepareNode:function(e,t){var n=this;if(this.options.debug&&(e.on("tooltipopen",(function(){var t=n._getPrevious(e),o=t.previousEdge,r=t.previousNode,i=n._getNext(e),a=i.nextEdge,s=i.nextNode;e.setTooltipContent("id: ".concat(n._getNodeId(e)," (on #").concat(n._getNodeContainerIndex(e),")<br>")+"previous edge: ".concat(n._getEdgeId(o))+" (on #".concat(n._getEdgeContainerIndex(o),") to ").concat(n._getNodeId(r),"<br>")+"next edge: ".concat(n._getEdgeId(a))+" (on #".concat(n._getEdgeContainerIndex(a),") to ").concat(n._getNodeId(s)))})),e.bindTooltip("<>")),t.getLayers().length>0){var o=t.getLayers()[0];e.setStyle({colorName:o.options.colorName})}else e.setStyle({colorName:u.nameOf(this._currentColorIndex)});return e.options.draggable&&(e.on("dragstart",(function(e){return n._onDragStartNode(e.target)})),e.on("drag",(function(e){return n._onDragNode(e.target)})),e.on("moveend",(function(e){return n.onMoveNode(e.target)}))),e.addTo(t),this},addNode:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=t||this.options.routingCallback;if(void 0!==this._lastNodeId&&!r){var a=this._getNode(this._lastNodeId);if(a.getLatLng().equals(e.getLatLng()))return new Promise((function(e){e()}))}this._fireStart();var s=this._nodesContainers.get(-1);if(this._prepareNode(e,s),void 0!==this._lastNodeId){var d=this._getNode(this._lastNodeId);this._createEdge(d,e)}var u=this._lastNodeId;this._lastNodeId=this._getNodeId(e),void 0===this._firstNodeId&&(this._firstNodeId=this._lastNodeId);var l=this._fireEvents;if(this._fireEvents=!1,"stopover"===e.options.type&&this.promoteNodeToStopover(e),this._fireEvents=l,void 0===u)return new Promise((function(e){e()})).then((function(){n._fireDone({})}));var c=this._getPrevious(e),f=c.previousEdge,h=c.previousNode;f._computation+=1;var g=f._computation;return new Promise((function(t,n){i.call(null,h,e,(function(r,i){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};null===r?(f._computation===g&&(h.setLatLng(o.default.latLng(i[0])),e.setLatLng(o.default.latLng(i[i.length-1])),f.setLatLngs(i),f.options.metadata=JSON.parse(JSON.stringify(a)),f.setStyle({dashArray:null})),t({routes:[{from:h,to:e,previousEdge:f}]})):n(r)}))})).then((function(e){n._fireDone({routes:e})})).catch((function(e){n._fireFailed(e)}))},insertNode:function(e,t,n){var r=this,i=n||this.options.routingCallback,a=this._getNode(t._startMarkerId),s=this._getNode(t._endMarkerId);t.removeFrom(this._getEdgeContainer(t)),this._prepareNode(e,this._getNodeContainer(a));var d=this._createEdge(a,e),u=this._createEdge(e,s);this._fireStart(),d._computation+=1,u._computation+=1;var l=d._computation,c=u._computation,f=new Promise((function(t,n){i.call(null,a,e,(function(r,i){var s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};null===r?(d._computation===l&&(a.setLatLng(o.default.latLng(i[0])),e.setLatLng(o.default.latLng(i[i.length-1])),d.setLatLngs(i),d.options.metadata=JSON.parse(JSON.stringify(s)),d.setStyle({dashArray:null})),t({from:a,to:e,edge:d})):n(r)}))})),h=new Promise((function(t,n){i.call(null,e,s,(function(r,i){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};null===r?(u._computation===c&&(e.setLatLng(o.default.latLng(i[0])),s.setLatLng(o.default.latLng(i[i.length-1])),u.setLatLngs(i),u.options.metadata=JSON.parse(JSON.stringify(a)),u.setStyle({dashArray:null})),t({from:e,to:s,edge:u})):n(r)}))}));return Promise.all([f,h]).then((function(e){r._fireDone({routes:e})})).catch((function(e){r._fireFailed(e)}))},_onDragStartNode:function(e){var t=this._getPrevious(e).previousEdge,n=this._getNext(e).nextEdge;return void 0!==t&&t.setStyle({dashArray:"4"}),void 0!==n&&n.setStyle({dashArray:"4"}),this},_onDragNode:function(e){var t=this._getPrevious(e),n=t.previousEdge,o=t.previousNode,r=this._getNext(e),i=r.nextEdge,a=r.nextNode;return void 0!==n&&n.setLatLngs([o.getLatLng(),e.getLatLng()]),void 0!==i&&i.setLatLngs([a.getLatLng(),e.getLatLng()]),this},onMoveNode:function(e,t){var n=this,r=t||this.options.routingCallback,i=[],a=this._getPrevious(e),s=a.previousEdge,d=a.previousNode,u=this._getNext(e),l=u.nextEdge,c=u.nextNode;if(this._fireStart(),this._onDragStartNode(e),this._onDragNode(e),void 0!==s){s._computation+=1;var f=s._computation;i.push(new Promise((function(t,n){r.call(null,d,e,(function(r,i){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};null===r?(s._computation===f&&(e.setLatLng(o.default.latLng(i[i.length-1])),s.setLatLngs(i),s.options.metadata=JSON.parse(JSON.stringify(a)),s.setStyle({dashArray:null})),t({from:d,to:e,edge:s})):n(r)}))})))}if(void 0!==l){l._computation+=1;var h=l._computation;i.push(new Promise((function(t,n){r.call(null,e,c,(function(r,i){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};null===r?(l._computation===h&&(e.setLatLng(o.default.latLng(i[0])),l.setLatLngs(i),l.options.metadata=JSON.parse(JSON.stringify(a)),l.setStyle({dashArray:null})),t({from:e,to:c,edge:l})):n(r)}))})))}return Promise.all(i).then((function(e){n._fireDone({routes:e})})).catch((function(e){n._fireFailed(e)}))},removeNode:function(e,t){var n=this,o=t||this.options.routingCallback,r=[];this._fireStart();var i=this._fireEvents;this._fireEvents=!1,this.demoteNodeToWaypoint(e),this._fireEvents=i;var a=this._getNodeContainer(e),s=this._getPrevious(e),d=s.previousEdge,u=s.previousNode,l=this._getNext(e),c=l.nextEdge,f=l.nextNode;if(void 0!==d&&void 0!==c){f._routeIdPrevious=e._routeIdPrevious,d._endMarkerId=c._endMarkerId,c.removeFrom(this._getEdgeContainer(c)),e.removeFrom(a),d.setLatLngs([u.getLatLng(),f.getLatLng()]).setStyle({dashArray:"4"}),d._computation+=1;var h=d._computation;r.push(new Promise((function(e,t){o.call(null,u,f,(function(n,o){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};null===n?(d._computation===h&&(d.setLatLngs(o).setStyle({dashArray:null}),d.options.metadata=JSON.parse(JSON.stringify(r))),e({from:u,to:f,edge:d})):t(n)}))})))}else void 0!==d?(u._routeIdNext=void 0,this._lastNodeId=d._startMarkerId,d.removeFrom(this._getEdgeContainer(d)),e.removeFrom(a)):void 0!==c?(f._routeIdPrevious=void 0,this._firstNodeId=c._endMarkerId,c.removeFrom(this._getEdgeContainer(c)),e.removeFrom(a)):(this._lastNodeId=void 0,this._firstNodeId=void 0,e.removeFrom(a));return Promise.all(r).then((function(e){n._fireDone({routes:e})})).catch((function(e){n._fireFailed(e)}))},promoteNodeToStopover:function(e){var t=this;if(e._promoted)return this;if(this._getNodeId(e)===this._firstNodeId)return e.setType("stopover"),e._promoted=!0,e._demoted=!1,this;this._fireStart();var n=this._getNodeContainerIndex(e),r=[],i=[],a=e;do{r.push(a);var s=this._getNext(a),d=s.nextEdge,l=s.nextNode;if(void 0===d)break;r.push(a),i.push(d),a=l}while("stopover"!==a.options.type);var c=o.default.featureGroup(),f=o.default.featureGroup();return this._nodesContainers.splice(n+1,0,c),this._edgesContainers.splice(n+1,0,f),this._currentColorIndex+=1,r.forEach((function(e){e.removeFrom(t._getNodeContainer(e)).addTo(c)})),i.forEach((function(e){e.removeFrom(t._getEdgeContainer(e)).addTo(f)})),c.setStyle({colorName:u.nameOf(this._currentColorIndex)}),f.setStyle({color:u.rgbOf(this._currentColorIndex)}),e.setType("stopover"),e._promoted=!0,e._demoted=!1,this._fireDone(),this},demoteNodeToWaypoint:function(e){var t=this;if(e._demoted)return this;var n=this._getNodeContainerIndex(e);if(0===n)return this;this._fireStart();var o=[],r=[],i=e;do{o.push(i);var a=this._getNext(i),s=a.nextEdge,d=a.nextNode;if(void 0===s)break;o.push(i),r.push(s),i=d}while("stopover"!==i.options.type);var u=this._nodesContainers.get(n-1),l=this._edgesContainers.get(n-1);this._nodesContainers.splice(n,1),this._edgesContainers.splice(n,1),o.forEach((function(e){e.removeFrom(t._getNodeContainer(e)).addTo(u)})),r.forEach((function(e){e.removeFrom(t._getEdgeContainer(e)).addTo(l)}));var c=this._getPrevious(o[0]),f=c.previousEdge,h=c.previousNode;return void 0!==f&&(u.setStyle({colorName:h.options.colorName}),l.setStyle({color:f.options.color})),e.setType("waypoint"),e._promoted=!1,e._demoted=!0,this._fireDone(),this}}),k={Track:m,track:function(e){return new m(e)}};function N(e,t,n){return e(n={path:t,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&n.path)}},n.exports),n.exports}var y=N((function(e){if(void 0===o.default.Control.EasyBar)e.exports={ToolBar:void 0,toolBar:void 0};else{var t=o.default.Control.EasyBar.extend({options:{mode:null,labelAddMarker:"Add marker on click",labelInsertMarker:"Insert marker when clicking on track",labelCloseLoop:"Close the loop",labelDeleteMarker:"Delete marker on click",labelPromoteMarker:"Promote to stopover on click",labelDemoteMarker:"Demote to waypoint on click",labelClean:"Remove everything now",labelUndo:"Undo",labelRedo:"Redo"},initialize:function(e,t){var n=this;this._track=e,o.default.Util.setOptions(this,t),o.default.Control.EasyBar.prototype.initialize.call(this,this._initializeButtons(),t),this.setMode(this.options.mode),this._track.getStepsContainer().on("click",(function(e){if("insert"===n.options.mode){var t=o.default.TrackDrawer.node(e.latlng),r=e.layer;r.setStyle({weight:3}),n._track.insertNode(t,r),n._bindMarkerEvents(t)}})),this._track.getStepsContainer().on("mouseover",(function(e){"insert"===n.options.mode&&e.layer.setStyle({weight:5})})),this._track.getStepsContainer().on("mouseout",(function(e){"insert"===n.options.mode&&e.layer.setStyle({weight:3})})),this._track._toolbar=this,this._track._bindMarkerEvents=function(e){n._bindMarkerEvents(e)}},setMode:function(e){switch(this.options.mode=e,this._addBtn.state("loaded"),this._insertBtn.state("loaded"),this._deleteBtn.state("loaded"),this._promoteBtn.state("loaded"),this._demoteBtn.state("loaded"),this._map&&(this._map.getContainer().style.cursor=""),this.options.mode){case"add":this._addBtn.state("active"),this._map&&(this._map.getContainer().style.cursor="pointer");break;case"insert":this._insertBtn.state("active");break;case"delete":this._deleteBtn.state("active");break;case"promote":this._promoteBtn.state("active");break;case"demote":this._demoteBtn.state("active")}return this},_initializeButtons:function(){var e=this,t=[];return this._addBtn=o.default.easyButton({id:"trackdrawer-add",states:[{stateName:"loaded",icon:"fa-plus",title:this.options.labelAddMarker,onClick:function(){e.setMode("add")}},{stateName:"active",icon:"fa-plus",title:this.options.labelAddMarker,onClick:function(){e.setMode(null)}}]}),t.push(this._addBtn),this._insertBtn=o.default.easyButton({id:"trackdrawer-insert",states:[{stateName:"loaded",icon:"fa-plus-circle",title:this.options.labelInsertMarker,onClick:function(){e.setMode("insert")}},{stateName:"active",icon:"fa-plus-circle",title:this.options.labelInsertMarker,onClick:function(){e.setMode(null)}}]}),t.push(this._insertBtn),this._closeLoop=o.default.easyButton({id:"trackdrawer-closeloop",states:[{stateName:"loaded",icon:"fa-magic",title:this.options.labelCloseLoop,onClick:function(){if(e._track.hasNodes(2)){var t=e._track.getNodes(),n=o.default.TrackDrawer.node(t[0].markers[0].getLatLng()).addTo(e._track);e._bindMarkerEvents(n)}}}]}),t.push(this._closeLoop),this._deleteBtn=o.default.easyButton({id:"trackdrawer-delete",states:[{stateName:"loaded",icon:"fa-eraser",title:this.options.labelDeleteMarker,onClick:function(){e.setMode("delete")}},{stateName:"active",icon:"fa-eraser",title:this.options.labelDeleteMarker,onClick:function(){e.setMode(null)}}]}),t.push(this._deleteBtn),this._promoteBtn=o.default.easyButton({id:"trackdrawer-promote",states:[{stateName:"loaded",icon:"fa-pause-circle",title:this.options.labelPromoteMarker,onClick:function(){e.setMode("promote")}},{stateName:"active",icon:"fa-pause-circle",title:this.options.labelPromoteMarker,onClick:function(){e.setMode(null)}}]}),t.push(this._promoteBtn),this._demoteBtn=o.default.easyButton({id:"trackdrawer-demote",states:[{stateName:"loaded",icon:"fa-map-signs",title:this.options.labelDemoteMarker,onClick:function(){e.setMode("demote")}},{stateName:"active",icon:"fa-map-signs",title:this.options.labelDemoteMarker,onClick:function(){e.setMode(null)}}]}),t.push(this._demoteBtn),this._cleanBtn=o.default.easyButton({id:"trackdrawer-clean",states:[{icon:"fa-trash",title:this.options.labelClean,onClick:function(){e._track.clean()}}]}),t.push(this._cleanBtn),this._track.options.undoable&&(this._undoBtn=o.default.easyButton({id:"trackdrawer-undo",states:[{icon:"fa-undo",title:this.options.labelUndo,onClick:function(){e._track.undo((function(t){var n=o.default.TrackDrawer.node(t);return e._bindMarkerEvents(n),n}))}}]}),t.push(this._undoBtn),this._redoBtn=o.default.easyButton({id:"trackdrawer-redo",states:[{icon:"fa-repeat",title:this.options.labelRedo,onClick:function(){e._track.redo((function(t){var n=o.default.TrackDrawer.node(t);return e._bindMarkerEvents(n),n}))}}]}),t.push(this._redoBtn)),this._track.on("TrackDrawer:start",(function(){e._track.options.undoable&&(e._undoBtn.disable(),e._redoBtn.disable())})),this._track.on("TrackDrawer:done",(function(){e._track.hasNodes(2)?e._closeLoop.enable():e._closeLoop.disable(),e._track.hasNodes()?(e._insertBtn.enable(),e._deleteBtn.enable(),e._promoteBtn.enable(),e._demoteBtn.enable(),e._cleanBtn.enable()):(e._insertBtn.disable(),e._deleteBtn.disable(),e._promoteBtn.disable(),e._demoteBtn.disable(),e._cleanBtn.disable()),e._track.options.undoable&&(e._track.isUndoable()?e._undoBtn.enable():e._undoBtn.disable(),e._track.isRedoable()?e._redoBtn.enable():e._redoBtn.disable())})),t},_bindMarkerEvents:function(e){return e.on("click",this._onMarkerClickHandler),e.on("mouseover",this._onMarkerMouseOverHandler),e.on("mouseout",this._onMarkerMouseOutHandler),this},onAdd:function(e){var t=this;return this._onMapClickHandler=function(e){if("add"===t.options.mode){var n=o.default.TrackDrawer.node(e.latlng).addTo(t._track);t._bindMarkerEvents(n)}},this._onMarkerClickHandler=function(e){var n=e.target;switch(t.options.mode){case"delete":var o=t._track._getPrevious(n).previousEdge,r=t._track._getNext(n).nextEdge;o&&o.setStyle({weight:3}),r&&r.setStyle({weight:3}),t._track.removeNode(n);break;case"promote":t._track.promoteNodeToStopover(n);break;case"demote":t._track.demoteNodeToWaypoint(n)}},this._onMarkerMouseOverHandler=function(e){if("delete"===t.options.mode||"promote"===t.options.mode||"demote"===t.options.mode){var n=e.target,o=t._track._getPrevious(n).previousEdge,r=t._track._getNext(n).nextEdge;o&&o.setStyle({weight:5}),r&&r.setStyle({weight:5})}},this._onMarkerMouseOutHandler=function(e){var n=e.target,o=t._track._getPrevious(n).previousEdge,r=t._track._getNext(n).nextEdge;o&&o.setStyle({weight:3}),r&&r.setStyle({weight:3})},o.default.DomEvent.on(e,"click",this._onMapClickHandler),o.default.Control.EasyBar.prototype.onAdd.call(this,e)},onRemove:function(e){var t=this;"add"===this.options.mode&&(e.getContainer().style.cursor=""),o.default.DomEvent.off(e,"click",this._onMapClickHandler),this._track.getNodes().forEach((function(e){e.markers.forEach((function(e){e.off("click",t._onMarkerClickHandler),e.off("mouseover",t._onMarkerMouseOverHandler),e.off("mouseout",t._onMarkerMouseOutHandler)}))}))}});e.exports={ToolBar:t,toolBar:function(e,n){return new t(e,n)}}}})),L=N((function(e){if(void 0===o.default.Control.EasyBar)e.exports={TraceModeBar:void 0,traceModeBar:void 0};else{var t=o.default.Control.EasyBar.extend({options:{mode:null},initialize:function(e,t,n){this._track=e,this._buttonsMap={},o.default.Control.EasyBar.prototype.initialize.call(this,this._initializeButtons(t),n),this.setMode(this.options.mode)},setMode:function(e){var t=this,n=Object.keys(this._buttonsMap),o=e;null===o&&(o=n[this.options.mode===n[0]?1:0]);return this.options.mode=o,n.forEach((function(e){t._buttonsMap[e].btn.state("loaded")})),this._buttonsMap[o].btn.state("active"),this._track.setOptions({router:this._buttonsMap[o].router,routingCallback:this._buttonsMap[o].routingCallback}),this},_initializeButtons:function(e){var t=this,n=[];return e.forEach((function(e){var r=o.default.easyButton({id:"trackdrawer-mode-".concat(e.id),states:[{stateName:"loaded",icon:e.icon,title:e.name,onClick:function(){t.setMode(e.id)}},{stateName:"active",icon:e.icon,title:e.name,onClick:function(){t.setMode(null)}}]});n.push(r),t._buttonsMap[e.id]={router:e.router,routingCallback:e.routingCallback,btn:r}})),n}});e.exports={TraceModeBar:t,traceModeBar:function(e,n,o){return new t(e,n,o)}}}})),b=o.default.Marker.extend({_routeIdPrevious:void 0,_routeIdNext:void 0,_promoted:!1,_demoted:!0,options:{type:"waypoint",colorName:"blue",opacity:1,draggable:!0,metadata:{}},initialize:function(e,t){o.default.Marker.prototype.initialize.call(this,e,t),o.default.setOptions(this,t),this.setType(this.options.type),this.options.metadata=JSON.parse(JSON.stringify(this.options.metadata))},setType:function(e){return this.options.type=e,"stopover"===e?this.setIcon(o.default.AwesomeMarkers.icon({icon:"pause-circle",markerColor:this.options.colorName,prefix:"fa"})):this.setIcon(o.default.AwesomeMarkers.icon({icon:"map-signs",markerColor:this.options.colorName,prefix:"fa"})),this},setStyle:function(e){return o.default.Util.setOptions(this,e),"colorName"in e&&this.setType(this.options.type),"opacity"in e&&this.setOpacity(this.options.opacity),this}}),x={Node:b,node:function(e,t){return new b(e,t)}};function E(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100;if(t<=0)throw new Error("`distance` must be positive");if(0===e.length)return[[]];var n=[];if(Array.isArray(e[0])){for(var r=0;r<e.length;r+=1)n=n.concat(E(e[r],t));return n}for(var i=e.splice(0,1);e.length>0;){var a=o.default.latLng(e.splice(0,1)[0]);i.push(a),a.distanceTo(i[0])>t&&(n.push(i),i=[a])}return n.push(i),n}function C(e){return e.getLayers().filter((function(e){return e instanceof o.default.Polyline}))}var S={splitPolyline:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100;return E(e.getLatLngs(),t).map((function(e){return o.default.polyline(e)}))},splitLatLngs:E,featureGroupToPolylines:C,featureGroupToLatLngs:function(e){return C(e).map((function(e){return[e.getLatLngs(),e.feature.properties]}))}},I=k.Track;I.include({_createFileLoader:function(){this._fileLoader=o.default.FileLayer.fileLoader(null,{addToMap:!1,fileSizeLimit:this.options.fileSizeLimit||1024,formats:this.options.fileFormat||[".geojson",".json",".kml",".gpx"]})},createFileLoaderControl:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return this._fileLoaderController=o.default.Control.fileLayerLoad({addToMap:!1,fileSizeLimit:this.options.fileSizeLimit||1024,formats:this.options.fileFormat||[".geojson",".json",".kml",".gpx"]}).addTo(this._map),this._fileLoaderController.loader.on("data:loaded",(function(n){e._dataLoadedHandler(n.layer,t)})),this._fileLoaderController},_dataLoadedHandler:function(e){var t=arguments,n=this;return a(regeneratorRuntime.mark((function r(){var i,a,s,d,u,l,c;return regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:i=t.length>1&&void 0!==t[1]&&t[1],n._fireStart(),a=n._fireEvents,n._fireEvents=!1,n.clean(),s=i?S.featureGroupToLatLngs(e).map((function(e){return[S.splitLatLngs(e[0]),e[1]]})):S.featureGroupToLatLngs(e).map((function(e){return[[e[0]],e[1]]})),u=void 0!==n._toolbar,l=regeneratorRuntime.mark((function e(t){var r,i,a;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=s[t][1],i=regeneratorRuntime.mark((function e(i){var a;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!((a=s[t][0][i]).length>0)){e.next=11;break}if(void 0!==d){e.next=7;break}return d=o.default.TrackDrawer.node(a[0]),e.next=6,n.addNode(d,void 0,!0);case 6:u&&n._bindMarkerEvents(d);case 7:return d=o.default.TrackDrawer.node(a[a.length-1],{type:i===s[t][0].length-1?"stopover":"waypoint"}),e.next=10,n.addNode(d,(function(e,t,n){n(null,a,r)}),!0);case 10:u&&n._bindMarkerEvents(d);case 11:case"end":return e.stop()}}),e)})),a=0;case 3:if(!(a<s[t][0].length)){e.next=8;break}return e.delegateYield(i(a),"t0",5);case 5:a+=1,e.next=3;break;case 8:case"end":return e.stop()}}),e)})),c=0;case 9:if(!(c<s.length)){r.next=14;break}return r.delegateYield(l(c),"t0",11);case 11:c+=1,r.next=9;break;case 14:n._fireEvents=a,n._fireDone();case 16:case"end":return r.stop()}}),r)})))()},loadData:function(e,t,n){var o=this,r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return new Promise((function(i,s){o._fileLoader.on("data:loaded",function(){var e=a(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o._dataLoadedHandler(t.layer,r);case 2:o._fileLoader.off(),i();case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),o._fileLoader.on("data:error",(function(e){o._fileLoader.off(),s(e.error)})),o._fileLoader.loadData(e,t,n)}))},loadFile:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return new Promise((function(o,r){t._fileLoader.on("data:loaded",function(){var e=a(regeneratorRuntime.mark((function e(r){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t._dataLoadedHandler(r.layer,n);case 2:t._fileLoader.off(),o();case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),t._fileLoader.on("data:error",(function(e){t._fileLoader.off(),r(e.error)})),t._fileLoader.load(e)}))},loadUrl:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],o=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=e.split("/").pop(),s=i.split(".").pop(),d=n?"fetch.php?url=".concat(encodeURI(e)):e;return new Promise((function(e,n){r.default(d,(function(r,d){if(r)if(r.responseText)try{var u=JSON.parse(r.responseText);n(new Error(u.error))}catch(e){n(new Error(r.statusText))}else r.statusText?n(new Error(r.statusText)):n(new Error(r));else try{t._fileLoader.on("data:loaded",function(){var n=a(regeneratorRuntime.mark((function n(r){return regeneratorRuntime.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,t._dataLoadedHandler(r.layer,o);case 2:t._fileLoader.off(),e();case 4:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}()),t._fileLoader.on("data:error",(function(e){t._fileLoader.off(),n(e.error)})),t._fileLoader.loadData(d.responseText,i,s)}catch(e){n(e)}}),!1)}))}}),I.addInitHook("_createFileLoader");var w=k.Track,M=k.track,B=y.ToolBar,T=y.toolBar,O=L.TraceModeBar,D=L.traceModeBar,P=x.Node,F=x.node,A=f.Edge,J=f.edge;return o.default.TrackDrawer={Track:w,track:M,ToolBar:B,toolBar:T,TraceModeBar:O,traceModeBar:D,LayerContainer:l,Node:P,node:F,Edge:A,edge:J,colors:u,latlngutils:S},o.default.TrackDrawer}));
//# sourceMappingURL=leaflet.trackdrawer.umd.min.js.map
